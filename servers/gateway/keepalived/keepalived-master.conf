# ============================================================================
# keepalived Configuration - MASTER Node
# ============================================================================
# Description: VRRP configuration for gateway high availability
# Node: gateway-1 (MASTER)
# Virtual IP: 10.0.1.100
# Priority: 100 (higher than BACKUP)
# ============================================================================

global_defs {
    # Notification email settings
    notification_email {
        ops@insightserenity.com
        devops@insightserenity.com
    }
    notification_email_from keepalived@gateway-1
    smtp_server localhost
    smtp_connect_timeout 30

    # Router ID (unique per server)
    router_id GATEWAY_1

    # Script user/group for security
    script_user root
    enable_script_security
}

# ============================================================================
# Health Check Script for NGINX
# ============================================================================

vrrp_script check_nginx {
    # Script to execute
    script "/usr/local/bin/check_nginx_health.sh"

    # Check interval (seconds)
    interval 2

    # Script timeout (seconds)
    timeout 3

    # Priority adjustment on failure (-20 means reduce priority by 20)
    weight -20

    # Number of consecutive failures before marking down
    fall 2

    # Number of consecutive successes before marking up
    rise 2
}

# ============================================================================
# VRRP Instance Configuration
# ============================================================================

vrrp_instance VI_GATEWAY {
    # Initial state (MASTER or BACKUP)
    state MASTER

    # Network interface to use
    interface eth0

    # Virtual Router ID (must be same across all nodes in this VRRP group)
    virtual_router_id 51

    # Priority (higher = more likely to become MASTER)
    # MASTER: 100, BACKUP: 90
    priority 100

    # Advertisement interval (seconds)
    advert_int 1

    # Preempt mode (take over if higher priority)
    # Set to nopreempt on BACKUP to prevent flapping
    preempt_delay 300

    # Authentication (must match on all nodes)
    authentication {
        auth_type PASS
        auth_pass SecureVRRPPass123!
    }

    # Virtual IP address (shared VIP)
    virtual_ipaddress {
        10.0.1.100/24 dev eth0 label eth0:vip
    }

    # Virtual routes (optional)
    # virtual_routes {
    #     0.0.0.0/0 via 10.0.1.1 dev eth0
    # }

    # Track scripts (health checks)
    track_script {
        check_nginx
    }

    # Notification scripts
    notify_master "/usr/local/bin/notify_master.sh"
    notify_backup "/usr/local/bin/notify_backup.sh"
    notify_fault "/usr/local/bin/notify_fault.sh"

    # Don't run scripts as root for security
    # But we need root for network operations, so enable it
    # script_security script_user
}

# ============================================================================
# Virtual Server Configuration (Optional - for health checking backends)
# ============================================================================

# If you want keepalived to also do load balancing (not recommended, use NGINX)
# Uncomment the following sections

# virtual_server 10.0.1.100 443 {
#     delay_loop 6
#     lb_algo rr
#     lb_kind NAT
#     persistence_timeout 50
#     protocol TCP
#
#     real_server 10.0.2.101 3000 {
#         weight 1
#         TCP_CHECK {
#             connect_timeout 3
#             connect_port 3000
#         }
#     }
#
#     real_server 10.0.2.102 3000 {
#         weight 1
#         TCP_CHECK {
#             connect_timeout 3
#             connect_port 3000
#         }
#     }
# }

# ============================================================================
# Notes
# ============================================================================
#
# Installation:
# 1. Install keepalived: apt-get install keepalived (Debian/Ubuntu)
#                        yum install keepalived (RHEL/CentOS)
# 2. Copy this file to /etc/keepalived/keepalived.conf
# 3. Copy health check script to /usr/local/bin/check_nginx_health.sh
# 4. Copy notification scripts to /usr/local/bin/
# 5. Make scripts executable: chmod +x /usr/local/bin/*.sh
# 6. Start keepalived: systemctl start keepalived
# 7. Enable on boot: systemctl enable keepalived
#
# Monitoring:
# - View status: systemctl status keepalived
# - View logs: journalctl -u keepalived -f
# - Check state: ip addr show eth0
# - Test failover: systemctl stop keepalived (on MASTER)
#
# Configuration for BACKUP node:
# - Change state to BACKUP
# - Change priority to 90 (lower than MASTER)
# - Change router_id to GATEWAY_2
# - Keep virtual_router_id the same (51)
# - Keep authentication password the same
# - Keep virtual_ipaddress the same
#
# Security:
# - Use strong authentication password (auth_pass)
# - Restrict VRRP traffic with firewall rules
# - Run scripts with minimal privileges where possible
#
# ============================================================================
