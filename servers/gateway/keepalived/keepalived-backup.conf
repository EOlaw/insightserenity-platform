# ============================================================================
# keepalived Configuration - BACKUP Node
# ============================================================================
# Description: VRRP configuration for gateway high availability
# Node: gateway-2 (BACKUP)
# Virtual IP: 10.0.1.100
# Priority: 90 (lower than MASTER)
# ============================================================================

global_defs {
    notification_email {
        ops@insightserenity.com
        devops@insightserenity.com
    }
    notification_email_from keepalived@gateway-2
    smtp_server localhost
    smtp_connect_timeout 30

    # Router ID (unique per server)
    router_id GATEWAY_2

    script_user root
    enable_script_security
}

# ============================================================================
# Health Check Script for NGINX
# ============================================================================

vrrp_script check_nginx {
    script "/usr/local/bin/check_nginx_health.sh"
    interval 2
    timeout 3
    weight -20
    fall 2
    rise 2
}

# ============================================================================
# VRRP Instance Configuration
# ============================================================================

vrrp_instance VI_GATEWAY {
    # Initial state (BACKUP)
    state BACKUP

    interface eth0

    # Same virtual router ID as MASTER
    virtual_router_id 51

    # Lower priority than MASTER (90 < 100)
    priority 90

    advert_int 1

    # Don't preempt - let MASTER stay MASTER even if this node comes back up
    nopreempt

    # Same authentication as MASTER
    authentication {
        auth_type PASS
        auth_pass SecureVRRPPass123!
    }

    # Same virtual IP as MASTER
    virtual_ipaddress {
        10.0.1.100/24 dev eth0 label eth0:vip
    }

    track_script {
        check_nginx
    }

    notify_master "/usr/local/bin/notify_master.sh"
    notify_backup "/usr/local/bin/notify_backup.sh"
    notify_fault "/usr/local/bin/notify_fault.sh"
}

# ============================================================================
# Notes for BACKUP Configuration
# ============================================================================
#
# Key Differences from MASTER:
# - state: BACKUP (not MASTER)
# - priority: 90 (lower than MASTER's 100)
# - router_id: GATEWAY_2 (unique identifier)
# - nopreempt: Prevents taking over from MASTER unnecessarily
#
# Same as MASTER:
# - virtual_router_id: 51 (must match)
# - auth_pass: Must match for security
# - virtual_ipaddress: Same VIP (10.0.1.100)
# - Health check script: Same monitoring
#
# Failover Behavior:
# 1. MASTER fails health check twice (4 seconds)
# 2. MASTER priority drops to 80 (100 - 20)
# 3. BACKUP (priority 90) becomes new MASTER
# 4. Virtual IP moves to BACKUP node
# 5. Traffic automatically routes to new MASTER
# 6. Total failover time: < 3 seconds
#
# Recovery Behavior:
# 1. Original MASTER comes back online
# 2. Due to nopreempt, it stays as BACKUP (priority 100 but won't take over)
# 3. Current MASTER continues serving traffic
# 4. Manual failover required if you want to restore original MASTER
#
# Manual Failover:
# - Stop keepalived on current MASTER: systemctl stop keepalived
# - Or restart with preempt enabled temporarily
#
# ============================================================================
