# ============================================================================
# Backend Upstream Configuration
# ============================================================================
# Description: Load balancer configuration for admin and customer backends
# Version: 1.0.0
# Last Updated: 2025-12-28
# ============================================================================

# ============================================================================
# Admin Backend Pool
# ============================================================================
# Load Balancing Method: Weighted Round Robin
# Purpose: Administrative operations, content management
# Security: Requires admin authentication
# ============================================================================

upstream admin_backend {
    # Shared memory zone for statistics and health tracking
    zone admin_backend 64k;

    # Load balancing method: weighted round-robin (default)
    # Traffic distribution: 40% / 40% / 20%

    # Primary instances (equal weight)
    server 10.0.2.101:3000 weight=100 max_fails=2 fail_timeout=10s;
    server 10.0.2.102:3000 weight=100 max_fails=2 fail_timeout=10s;

    # Secondary instance (lower weight for canary deployments)
    server 10.0.2.103:3000 weight=50 max_fails=2 fail_timeout=10s;

    # Backup server (only used when all primary servers are down)
    server 10.0.2.104:3000 backup;

    # Connection pooling for better performance
    keepalive 32;                # Maintain 32 idle connections
    keepalive_timeout 60s;       # Keep connections alive for 60s
    keepalive_requests 100;      # Reuse connection for 100 requests

    # Health check configuration (NGINX Plus only)
    # For NGINX OSS, health is determined by max_fails and fail_timeout
    # health_check interval=5s fails=2 passes=2 uri=/health match=admin_healthy;
}

# ============================================================================
# Customer Backend Pool
# ============================================================================
# Load Balancing Method: Least Connections
# Purpose: Customer-facing APIs, consultation booking, payments
# Optimized for: Variable request processing times
# ============================================================================

upstream customer_backend {
    # Shared memory zone for statistics
    zone customer_backend 64k;

    # Load balancing method: least connections
    # Routes to instance with fewest active connections
    least_conn;

    # Backend instances (equal configuration)
    server 10.0.3.101:3001 max_fails=2 fail_timeout=10s max_conns=500;
    server 10.0.3.102:3001 max_fails=2 fail_timeout=10s max_conns=500;
    server 10.0.3.103:3001 max_fails=2 fail_timeout=10s max_conns=500;
    server 10.0.3.104:3001 max_fails=2 fail_timeout=10s max_conns=500;
    server 10.0.3.105:3001 max_fails=2 fail_timeout=10s max_conns=500;

    # Backup server
    server 10.0.3.106:3001 backup;

    # Connection pooling
    keepalive 64;                # Higher pool for customer traffic
    keepalive_timeout 60s;
    keepalive_requests 100;

    # Health check (NGINX Plus)
    # health_check interval=5s fails=2 passes=2 uri=/health match=customer_healthy;
}

# ============================================================================
# WebSocket Backend Pool (with sticky sessions)
# ============================================================================
# Load Balancing Method: IP Hash (for session persistence)
# Purpose: WebSocket connections, real-time notifications
# ============================================================================

upstream websocket_backend {
    zone websocket_backend 64k;

    # IP hash for sticky sessions (keeps client on same server)
    ip_hash;

    # Backend instances
    server 10.0.3.101:3001 max_fails=1 fail_timeout=30s;
    server 10.0.3.102:3001 max_fails=1 fail_timeout=30s;
    server 10.0.3.103:3001 max_fails=1 fail_timeout=30s;

    # Longer keepalive for WebSocket connections
    keepalive 128;
    keepalive_timeout 300s;
}

# ============================================================================
# Health Check Matchers (NGINX Plus only)
# ============================================================================
# These define what constitutes a "healthy" response from backends
# For NGINX OSS, remove or comment out these sections
# ============================================================================

# Admin backend health check matcher
# match admin_healthy {
#     status 200;
#     header Content-Type ~ "application/json";
#     body ~ "\"status\":\"healthy\"";
#     body ~ "\"database\"";
# }

# Customer backend health check matcher
# match customer_healthy {
#     status 200;
#     header Content-Type ~ "application/json";
#     body ~ "\"status\":\"healthy\"";
#     body ~ "\"database\"";
# }

# ============================================================================
# Development/Staging Upstreams
# ============================================================================
# Uncomment for development or staging environments
# ============================================================================

# upstream admin_backend_dev {
#     zone admin_backend_dev 64k;
#     server 10.0.2.201:3000;
#     keepalive 8;
# }

# upstream customer_backend_dev {
#     zone customer_backend_dev 64k;
#     least_conn;
#     server 10.0.3.201:3001;
#     keepalive 16;
# }

# ============================================================================
# Notes
# ============================================================================
#
# Upstream Parameters:
# - weight: Traffic distribution (default: 1)
# - max_fails: Failed attempts before marking down (default: 1)
# - fail_timeout: Time to consider server down after max_fails (default: 10s)
# - max_conns: Maximum concurrent connections (NGINX Plus only)
# - backup: Only used when all non-backup servers are down
# - down: Permanently mark server as unavailable
#
# Load Balancing Methods:
# - round-robin (default): Distribute evenly in order
# - least_conn: Route to server with fewest connections
# - ip_hash: Hash client IP for sticky sessions
# - hash: Generic consistent hashing
# - random: Random selection (with optional two parameter)
#
# Connection Pooling:
# - keepalive: Number of idle connections to keep open
# - keepalive_timeout: How long to keep idle connections
# - keepalive_requests: Max requests per connection before closing
#
# Health Checks (NGINX Plus):
# - interval: Time between checks
# - fails: Consecutive failures before marking down
# - passes: Consecutive successes before marking up
# - uri: Health check endpoint
# - match: Response matcher name
#
# ============================================================================
