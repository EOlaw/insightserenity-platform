# ============================================================================
# Upstream Backend Configuration - Local Testing with Real Servers
# ============================================================================
# This configuration connects to real admin-server and customer-services
# running on the host machine (localhost:3000 and localhost:3001)
# ============================================================================

# ==========================================================================
# Admin Backend
# ==========================================================================
upstream admin_backend {
    zone admin_backend 64k;

    # Real admin-server running on host
    # On macOS/Windows Docker Desktop: use host.docker.internal
    # On Linux: use host-gateway (configured in docker-compose)
    server host.docker.internal:3000 weight=100 max_fails=2 fail_timeout=10s;

    # Keepalive connections for performance
    keepalive 32;
    keepalive_requests 100;
    keepalive_timeout 60s;
}

# ==========================================================================
# Customer Backend
# ==========================================================================
upstream customer_backend {
    zone customer_backend 64k;

    # Least connections algorithm (optimal for variable request times)
    least_conn;

    # Real customer-services running on host
    server host.docker.internal:3001 max_fails=2 fail_timeout=10s max_conns=500;

    # Keepalive connections for performance
    keepalive 64;
    keepalive_requests 100;
    keepalive_timeout 60s;
}

# ==========================================================================
# WebSocket Backend (if needed)
# ==========================================================================
upstream websocket_backend {
    zone websocket_backend 64k;

    # IP hash for sticky sessions (WebSocket requirement)
    ip_hash;

    # Using customer-services WebSocket endpoints
    server host.docker.internal:3001 max_fails=2 fail_timeout=10s;

    # Longer keepalive for WebSocket connections
    keepalive 32;
    keepalive_timeout 120s;
}
