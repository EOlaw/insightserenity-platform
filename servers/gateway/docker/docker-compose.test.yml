# ============================================================================
# Docker Compose - Local Testing with Real Backend Services
# ============================================================================
# Description: Minimal gateway setup to test with real admin-server and
#              customer-services running on host machine
# Usage: docker-compose -f docker-compose.test.yml up
# ============================================================================

version: '3.8'

services:
  # ==========================================================================
  # NGINX Gateway (Test)
  # ==========================================================================
  gateway:
    image: nginx:1.24-alpine
    container_name: gateway-test
    hostname: gateway-test
    ports:
      - "80:80"
      - "443:443"
    volumes:
      # Main NGINX configuration
      - ../nginx/nginx.conf:/etc/nginx/nginx.conf:ro

      # Use local test upstreams (points to host.docker.internal)
      - ../nginx/upstreams/backends-local-test.conf:/etc/nginx/upstreams/backends.conf:ro

      # Virtual host configuration (test version without SSL)
      - ../nginx/sites-available/localhost-test.conf:/etc/nginx/sites-enabled/default.conf:ro

      # Cache and logs
      - nginx-cache:/var/cache/nginx
      - nginx-logs:/var/log/nginx
    extra_hosts:
      # For Linux: Map host.docker.internal to host machine
      - "host.docker.internal:host-gateway"
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/health"]
      interval: 10s
      timeout: 3s
      retries: 3
      start_period: 5s
    restart: unless-stopped

# ============================================================================
# Volumes
# ============================================================================
volumes:
  nginx-cache:
  nginx-logs:
